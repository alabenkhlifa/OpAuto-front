import{E as m,a as u,b as l,f as v,h as s,u as y}from"./chunk-JES5V5RQ.js";var g=class h{invoicesSubject=new v([]);invoices$=this.invoicesSubject.asObservable();paymentsSubject=new v([]);payments$=this.paymentsSubject.asObservable();serviceRatesSubject=new v([]);serviceRates$=this.serviceRatesSubject.asObservable();searchQuery=m("");selectedStatus=m("all");selectedPaymentMethod=m("all");dateRange=m({});invoiceSettings={garageInfo:{name:"OpAuto Garage",address:"123 Avenue Habib Bourguiba",city:"Tunis",postalCode:"1000",country:"Tunisia",phone:"+216-71-123-456",email:"contact@opautogatage.tn",website:"www.opautogarage.tn",taxId:"TN123456789",bankDetails:{bankName:"Banque de Tunisie",accountNumber:"20127000123456789",routingNumber:"20127",iban:"TN59 2012 7000 1234 5678 9012"}},taxSettings:{defaultTaxRate:19,taxName:"TVA",taxNumber:"TN123456789",taxExemptItems:[]},paymentTerms:{defaultTerms:"Payment due within 30 days",dueDays:30,lateFeePercentage:2,lateFeeGraceDays:7},invoiceNumbering:{prefix:"INV",currentNumber:1001,resetPeriod:"yearly",digitCount:4}};mockServiceRates=[{id:"service1",serviceCode:"OIL_CHANGE",serviceName:"Oil Change & Filter",description:"Complete oil change with filter replacement",category:"maintenance",basePrice:120,laborHours:1.5,hourlyRate:80,isActive:!0},{id:"service2",serviceCode:"BRAKE_SERVICE",serviceName:"Brake System Service",description:"Brake pads replacement and system check",category:"safety",basePrice:350,laborHours:3,hourlyRate:80,isActive:!0},{id:"service3",serviceCode:"ENGINE_DIAG",serviceName:"Engine Diagnostic",description:"Complete engine diagnostic and tune-up",category:"diagnostic",basePrice:200,laborHours:2.5,hourlyRate:80,isActive:!0},{id:"service4",serviceCode:"TIRE_SERVICE",serviceName:"Tire Service",description:"Tire rotation, balancing, and alignment",category:"maintenance",basePrice:150,laborHours:2,hourlyRate:80,isActive:!0}];mockInvoices=[{id:"inv1",invoiceNumber:"INV-2025-1001",customerId:"customer1",carId:"car1",appointmentId:"1",issueDate:new Date(2025,7,25),dueDate:new Date(2025,8,24),status:"paid",paymentMethod:"cash",paymentDate:new Date(2025,7,26),currency:"TND",subtotal:450,taxRate:19,taxAmount:85.5,discountPercentage:0,discountAmount:0,totalAmount:535.5,paidAmount:535.5,remainingAmount:0,lineItems:[{id:"line1",type:"service",description:"Oil Change & Filter Replacement",quantity:1,unit:"service",unitPrice:120,totalPrice:120,serviceCode:"OIL_CHANGE",mechanicId:"mechanic1",laborHours:1.5,taxable:!0},{id:"line2",type:"part",description:"Engine Oil 5W-30 (5L)",quantity:2,unit:"bottle",unitPrice:45.5,totalPrice:91,partId:"part1",taxable:!0},{id:"line3",type:"labor",description:"Mechanic Labor (1.5 hours)",quantity:1.5,unit:"hour",unitPrice:80,totalPrice:120,mechanicId:"mechanic1",laborHours:1.5,taxable:!0},{id:"line4",type:"part",description:"Oil Filter",quantity:1,unit:"piece",unitPrice:25,totalPrice:25,partId:"part6",taxable:!0},{id:"line5",type:"misc",description:"Environmental Disposal Fee",quantity:1,unit:"service",unitPrice:15,totalPrice:15,taxable:!0}],notes:"Customer requested synthetic oil. Next service due in 6 months.",paymentTerms:"Payment due within 30 days",createdBy:"admin1",createdAt:new Date(2025,7,25),updatedAt:new Date(2025,7,26),customerName:"Ahmed Ben Ali",customerPhone:"+216-20-123-456",customerEmail:"ahmed.benali@email.tn",carMake:"BMW",carModel:"X5",carYear:2020,licensePlate:"123 TUN 2024",serviceName:"Oil Change & Filter Replacement",mechanicName:"Karim Mechanic",paymentHistory:[]},{id:"inv2",invoiceNumber:"INV-2025-1002",customerId:"customer2",carId:"car2",appointmentId:"2",issueDate:new Date(2025,7,28),dueDate:new Date(2025,8,27),status:"sent",currency:"TND",subtotal:720,taxRate:19,taxAmount:136.8,discountPercentage:5,discountAmount:36,totalAmount:820.8,paidAmount:0,remainingAmount:820.8,lineItems:[{id:"line6",type:"service",description:"Front Brake Pads Replacement",quantity:1,unit:"service",unitPrice:350,totalPrice:350,serviceCode:"BRAKE_SERVICE",mechanicId:"mechanic2",laborHours:3,taxable:!0},{id:"line7",type:"part",description:"Brake Pads Front Set - Bosch",quantity:1,unit:"set",unitPrice:180,totalPrice:180,partId:"part2",taxable:!0},{id:"line8",type:"labor",description:"Mechanic Labor (3 hours)",quantity:3,unit:"hour",unitPrice:80,totalPrice:240,mechanicId:"mechanic2",laborHours:3,taxable:!0}],notes:"Customer complained about brake noise. Brake pads were worn out.",paymentTerms:"Payment due within 30 days",createdBy:"admin1",createdAt:new Date(2025,7,28),updatedAt:new Date(2025,7,28),customerName:"Fatma Trabelsi",customerPhone:"+216-25-789-123",customerEmail:"fatma.trabelsi@email.tn",carMake:"Honda",carModel:"Civic",carYear:2019,licensePlate:"456 TUN 2019",serviceName:"Front Brake Pads Replacement",mechanicName:"Ahmed Mechanic",paymentHistory:[]},{id:"inv3",invoiceNumber:"INV-2025-1003",customerId:"customer3",carId:"car4",issueDate:new Date(2025,7,20),dueDate:new Date(2025,8,19),status:"overdue",currency:"TND",subtotal:280,taxRate:19,taxAmount:53.2,discountPercentage:0,discountAmount:0,totalAmount:333.2,paidAmount:200,remainingAmount:133.2,lineItems:[{id:"line9",type:"service",description:"Routine Maintenance Check",quantity:1,unit:"service",unitPrice:150,totalPrice:150,serviceCode:"ROUTINE_CHECK",mechanicId:"mechanic1",laborHours:2,taxable:!0},{id:"line10",type:"labor",description:"Mechanic Labor (2 hours)",quantity:2,unit:"hour",unitPrice:80,totalPrice:160,mechanicId:"mechanic1",laborHours:2,taxable:!0}],notes:"Customer made partial payment. Follow up required.",paymentTerms:"Payment due within 30 days",createdBy:"admin1",createdAt:new Date(2025,7,20),updatedAt:new Date(2025,7,25),customerName:"Mohamed Khemir",customerPhone:"+216-22-456-789",customerEmail:"mohamed.khemir@email.tn",carMake:"Mercedes",carModel:"C-Class",carYear:2022,licensePlate:"321 TUN 2022",serviceName:"Routine Maintenance Check",mechanicName:"Karim Mechanic",paymentHistory:[{id:"pay1",invoiceId:"inv3",amount:200,method:"cash",paymentDate:new Date(2025,7,22),notes:"Partial payment",processedBy:"admin1",createdAt:new Date(2025,7,22)}]}];mockPayments=[{id:"pay1",invoiceId:"inv3",amount:200,method:"cash",paymentDate:new Date(2025,7,22),notes:"Partial payment",processedBy:"admin1",createdAt:new Date(2025,7,22)}];constructor(){this.invoicesSubject.next(this.mockInvoices),this.paymentsSubject.next(this.mockPayments),this.serviceRatesSubject.next(this.mockServiceRates)}getInvoices(){return this.invoices$}getInvoiceById(e){return this.mockInvoices.find(t=>t.id===e)}createInvoice(e){let t=this.calculateInvoiceTotals(e.lineItems,e.discountPercentage||0),i=l(u({},e),{id:Date.now().toString(),invoiceNumber:this.generateInvoiceNumber(),subtotal:t.subtotal,taxAmount:t.taxAmount,discountAmount:t.discountAmount,totalAmount:t.totalAmount,remainingAmount:t.totalAmount,createdAt:new Date,updatedAt:new Date,customerName:"",customerPhone:"",carMake:"",carModel:"",carYear:0,licensePlate:"",paymentHistory:[]});return this.populateInvoiceDetails(i),this.mockInvoices.push(i),this.invoicesSubject.next([...this.mockInvoices]),s(i)}updateInvoice(e,t){let i=this.mockInvoices.findIndex(a=>a.id===e);if(i!==-1){let a=this.mockInvoices[i],r={subtotal:a.subtotal,taxAmount:a.taxAmount,discountAmount:a.discountAmount,totalAmount:a.totalAmount};(t.lineItems||t.discountPercentage!==void 0)&&(r=this.calculateInvoiceTotals(t.lineItems||a.lineItems,t.discountPercentage??a.discountPercentage));let n=l(u(u(u({},a),t),r),{remainingAmount:r.totalAmount-(t.paidAmount??a.paidAmount),updatedAt:new Date});return this.mockInvoices[i]=n,this.invoicesSubject.next([...this.mockInvoices]),s(n)}throw new Error("Invoice not found")}deleteInvoice(e){let t=this.mockInvoices.findIndex(i=>i.id===e);return t!==-1?(this.mockInvoices.splice(t,1),this.invoicesSubject.next([...this.mockInvoices]),s(!0)):s(!1)}addPayment(e){let t=l(u({},e),{id:Date.now().toString(),createdAt:new Date});return this.mockPayments.push(t),this.paymentsSubject.next([...this.mockPayments]),this.updateInvoicePaymentStatus(e.invoiceId,e.amount),s(t)}getPaymentsByInvoice(e){let t=this.mockPayments.filter(i=>i.invoiceId===e);return s(t.sort((i,a)=>a.paymentDate.getTime()-i.paymentDate.getTime()))}createInvoiceFromAppointment(e,t=[]){let i=this.mockServiceRates.find(n=>n.serviceCode===e.serviceType.toUpperCase().replace("-","_")),a=[];i&&(a.push({id:`service_${Date.now()}`,type:"service",description:e.serviceName,quantity:1,unit:"service",unitPrice:i.basePrice,totalPrice:i.basePrice,serviceCode:i.serviceCode,mechanicId:e.mechanicId,laborHours:i.laborHours,taxable:!0}),a.push({id:`labor_${Date.now()}`,type:"labor",description:`Mechanic Labor (${i.laborHours} hours)`,quantity:i.laborHours,unit:"hour",unitPrice:i.hourlyRate,totalPrice:i.laborHours*i.hourlyRate,mechanicId:e.mechanicId,laborHours:i.laborHours,taxable:!0})),t.forEach(n=>{a.push({id:`part_${Date.now()}_${n.id}`,type:"part",description:`${n.name} - ${n.brand}`,quantity:n.quantityUsed||1,unit:n.unit,unitPrice:n.price,totalPrice:n.price*(n.quantityUsed||1),partId:n.id,taxable:!0})});let r={customerId:e.customerId,carId:e.carId,appointmentId:e.id,issueDate:new Date,dueDate:new Date(Date.now()+this.invoiceSettings.paymentTerms.dueDays*24*60*60*1e3),status:"draft",currency:"TND",taxRate:this.invoiceSettings.taxSettings.defaultTaxRate,discountPercentage:0,paidAmount:0,lineItems:a,notes:e.notes,paymentTerms:this.invoiceSettings.paymentTerms.defaultTerms,createdBy:"current-user"};return this.createInvoice(r)}calculateInvoiceTotals(e,t=0){let i=e.reduce((d,b)=>d+b.totalPrice,0),a=i*t/100,r=i-a,n=r*this.invoiceSettings.taxSettings.defaultTaxRate/100,p=r+n;return{subtotal:i,taxAmount:n,discountAmount:a,totalAmount:p}}calculateLineItemTotal(e,t,i=0){let a=e*t,r=a*i/100;return a-r}searchInvoices(e){let t=[...this.mockInvoices];if(e.query){let i=e.query.toLowerCase();t=t.filter(a=>a.invoiceNumber.toLowerCase().includes(i)||a.customerName.toLowerCase().includes(i)||a.licensePlate.toLowerCase().includes(i)||a.serviceName?.toLowerCase().includes(i))}return e.status&&(t=t.filter(i=>i.status===e.status)),e.customerId&&(t=t.filter(i=>i.customerId===e.customerId)),e.paymentMethod&&(t=t.filter(i=>i.paymentMethod===e.paymentMethod)),e.dateFrom&&(t=t.filter(i=>i.issueDate>=e.dateFrom)),e.dateTo&&(t=t.filter(i=>i.issueDate<=e.dateTo)),e.minAmount&&(t=t.filter(i=>i.totalAmount>=e.minAmount)),e.maxAmount&&(t=t.filter(i=>i.totalAmount<=e.maxAmount)),s(t.sort((i,a)=>a.issueDate.getTime()-i.issueDate.getTime()))}getInvoiceStats(){let e=this.mockInvoices.length,t=this.mockInvoices.reduce((o,c)=>o+c.totalAmount,0),i=this.mockInvoices.filter(o=>o.status==="paid").length,a=this.mockInvoices.filter(o=>["sent","viewed"].includes(o.status)).length,r=this.mockInvoices.filter(o=>o.status==="overdue").length,n=e>0?t/e:0,p=new Date().getMonth(),d=new Date().getFullYear(),b=this.mockInvoices.filter(o=>o.issueDate.getMonth()===p&&o.issueDate.getFullYear()===d).reduce((o,c)=>o+c.paidAmount,0),P=this.mockInvoices.filter(o=>o.issueDate.getFullYear()===d).reduce((o,c)=>o+c.paidAmount,0),A=this.mockInvoices.reduce((o,c)=>(c.paymentMethod&&(o[c.paymentMethod]=(o[c.paymentMethod]||0)+1),o),{}),f=Object.entries(A).map(([o,c])=>({method:o,count:c,totalAmount:this.mockInvoices.filter(I=>I.paymentMethod===o).reduce((I,S)=>I+S.paidAmount,0),percentage:c/e*100})),D={totalInvoices:e,totalRevenue:t,paidInvoices:i,pendingInvoices:a,overdueInvoices:r,averageInvoiceAmount:n,monthlyRevenue:b,yearlyRevenue:P,topCustomers:[],recentInvoices:[...this.mockInvoices].sort((o,c)=>c.createdAt.getTime()-o.createdAt.getTime()).slice(0,10),paymentMethodStats:f};return s(D)}getServiceRates(){return this.serviceRates$}getServiceRateByCode(e){return this.mockServiceRates.find(t=>t.serviceCode===e)}getInvoiceSettings(){return s(this.invoiceSettings)}updateInvoiceSettings(e){return this.invoiceSettings=u(u({},this.invoiceSettings),e),s(this.invoiceSettings)}getStatusColor(e){return{draft:"text-gray-600",sent:"text-blue-600",viewed:"text-blue-600",paid:"text-green-600","partially-paid":"text-amber-600",overdue:"text-red-600",cancelled:"text-gray-400",refunded:"text-purple-600"}[e]||"text-gray-600"}getStatusBadgeClass(e){let t={draft:"badge badge-neutral",sent:"badge badge-active",viewed:"badge badge-active",paid:"badge badge-completed","partially-paid":"badge badge-pending",overdue:"badge badge-priority-urgent",cancelled:"badge badge-cancelled",refunded:"badge badge-info"};return t[e]||t.draft}formatCurrency(e,t="TND"){return new Intl.NumberFormat("fr-TN",{style:"currency",currency:t}).format(e)}formatDate(e){return new Intl.DateTimeFormat("fr-TN",{year:"numeric",month:"short",day:"numeric"}).format(e)}generateInvoiceNumber(){let e=this.invoiceSettings.invoiceNumbering,t=new Date().getFullYear(),i=e.currentNumber.toString().padStart(e.digitCount,"0");return e.currentNumber++,`${e.prefix}-${t}-${i}`}updateInvoicePaymentStatus(e,t){let i=this.getInvoiceById(e);if(i){let a=i.paidAmount+t,r=i.totalAmount-a,n="paid";r>0&&(n="partially-paid"),this.updateInvoice(e,{paidAmount:a,remainingAmount:r,status:n,paymentDate:r===0?new Date:void 0})}}populateInvoiceDetails(e){let t=[{id:"customer1",name:"Ahmed Ben Ali",phone:"+216-20-123-456",email:"ahmed.benali@email.tn"},{id:"customer2",name:"Fatma Trabelsi",phone:"+216-25-789-123",email:"fatma.trabelsi@email.tn"},{id:"customer3",name:"Mohamed Khemir",phone:"+216-22-456-789",email:"mohamed.khemir@email.tn"}],i=[{id:"car1",licensePlate:"123 TUN 2024",make:"BMW",model:"X5",year:2020},{id:"car2",licensePlate:"456 TUN 2019",make:"Honda",model:"Civic",year:2019},{id:"car4",licensePlate:"321 TUN 2022",make:"Mercedes",model:"C-Class",year:2022}],a=t.find(n=>n.id===e.customerId),r=i.find(n=>n.id===e.carId);a&&(e.customerName=a.name,e.customerPhone=a.phone,e.customerEmail=a.email),r&&(e.carMake=r.make,e.carModel=r.model,e.carYear=r.year,e.licensePlate=r.licensePlate)}static \u0275fac=function(t){return new(t||h)};static \u0275prov=y({token:h,factory:h.\u0275fac,providedIn:"root"})};export{g as a};
