import{C as n,M as i,P as g,j as m,m as o,n as s}from"./chunk-DMTVNCDT.js";var f={owner:"Owner",staff:"Staff"},u={INVALID_CREDENTIALS:"Invalid username/email or password",EMAIL_ALREADY_EXISTS:"An account with this email already exists",USERNAME_ALREADY_EXISTS:"An account with this username already exists",EMAIL_NOT_FOUND:"No account found with this email address",USERNAME_NOT_FOUND:"No account found with this username",WEAK_PASSWORD:"Password must be at least 8 characters with uppercase, lowercase, and numbers",INVALID_EMAIL:"Please enter a valid email address",INVALID_USERNAME:"Username must be 3-20 characters and contain only letters, numbers, and underscores",ACCOUNT_LOCKED:"Account has been locked due to too many failed login attempts",SESSION_EXPIRED:"Your session has expired. Please log in again",NETWORK_ERROR:"Network error. Please check your connection and try again",SERVER_ERROR:"Server error. Please try again later",UNAUTHORIZED:"You are not authorized to perform this action"};var d=class c{STORAGE_KEYS={TOKEN:"opauth_token",REFRESH_TOKEN:"opauth_refresh_token",USER:"opauth_user",REMEMBER_ME:"opauth_remember_me"};currentUserSubject=new m(null);currentUser$=this.currentUserSubject.asObservable();isAuthenticatedSubject=new m(!1);isAuthenticated$=this.isAuthenticatedSubject.asObservable();constructor(){let e=this.getUserFromStorage(),r=this.hasValidToken();e&&r?(this.currentUserSubject.next(e),this.isAuthenticatedSubject.next(!0)):(this.currentUserSubject.next(null),this.isAuthenticatedSubject.next(!1))}login(e){return this.validateLoginCredentials(e).pipe(n(1500),i(r=>{this.storeAuthData(r,e.rememberMe),this.currentUserSubject.next(r.user),this.isAuthenticatedSubject.next(!0),r.user.subscriptionTier&&setTimeout(()=>{window.dispatchEvent(new StorageEvent("storage",{key:"opauth_user",newValue:JSON.stringify(r.user),storageArea:e.rememberMe?localStorage:sessionStorage}))},0)}))}register(e){return this.validateRegistrationData(e).pipe(n(2e3),i(r=>{this.storeAuthData(r,!1),this.currentUserSubject.next(r.user),this.isAuthenticatedSubject.next(!0)}))}logout(){return o(!0).pipe(n(300),i(()=>{this.clearAuthData(),this.currentUserSubject.next(null),this.isAuthenticatedSubject.next(!1)}))}forgotPassword(e){return["admin@example.com","mechanic@example.com"].includes(e.email)?o({message:"Password reset instructions sent to your email"}).pipe(n(1e3)):s(()=>({code:"EMAIL_NOT_FOUND",message:u.EMAIL_NOT_FOUND}))}resetPassword(e){return e.password!==e.confirmPassword?s(()=>({code:"PASSWORDS_DONT_MATCH",message:"Passwords do not match"})):o({message:"Password reset successfully"}).pipe(n(1e3))}changePassword(e){return e.newPassword!==e.confirmPassword?s(()=>({code:"PASSWORDS_DONT_MATCH",message:"New passwords do not match"})):e.currentPassword==="wrongpassword"?s(()=>({code:"INVALID_CURRENT_PASSWORD",message:"Current password is incorrect"})):o({message:"Password changed successfully"}).pipe(n(1e3))}refreshToken(){if(!localStorage.getItem(this.STORAGE_KEYS.REFRESH_TOKEN))return s(()=>({code:"NO_REFRESH_TOKEN",message:"No refresh token available"}));let r=this.currentUserSubject.value;if(!r)return s(()=>({code:"NO_USER",message:"No user data available"}));let a={user:r,token:`mock_token_${Date.now()}`,refreshToken:`mock_refresh_${Date.now()}`,expiresIn:3600};return o(a).pipe(n(500),i(t=>{this.storeAuthData(t,!0)}))}getCurrentUser(){return this.currentUserSubject.value}isLoggedIn(){return this.isAuthenticatedSubject.value}hasRole(e){let r=this.getCurrentUser();return r?r.role===e:!1}isOwner(){return this.hasRole("owner")}isStaff(){return this.hasRole("staff")}createStaffAccount(e){if(!this.isOwner())return s(()=>({code:"UNAUTHORIZED",message:u.UNAUTHORIZED}));if(e.password!==e.confirmPassword)return s(()=>({code:"PASSWORDS_DONT_MATCH",message:"Passwords do not match"}));if(!/^[a-zA-Z0-9_]{3,20}$/.test(e.username))return s(()=>({code:"INVALID_USERNAME",message:u.INVALID_USERNAME}));let a={id:`user_${Date.now()}`,username:e.username,name:e.name,role:e.role,garageName:this.getCurrentUser()?.garageName||"OpAuto Garage",phoneNumber:e.phoneNumber,isActive:!0,createdAt:new Date,updatedAt:new Date,preferences:{theme:"system",language:"en",notifications:{email:!1,sms:!1,browser:!0},dashboardLayout:"standard"}};return o(a).pipe(n(1e3))}validateLoginCredentials(e){let r=[{email:"solo@opauto.tn",username:null,password:"solo123",name:"Mohammed Karim",role:"owner",garageName:"Garage Solo M\xE9canique",subscriptionTier:"solo"},{email:"starter@opauto.tn",username:null,password:"starter123",name:"Ahmed Ben Salah",role:"owner",garageName:"Garage Starter Auto",subscriptionTier:"starter"},{email:null,username:"starter_staff1",password:"staff123",name:"Sara Mansouri",role:"staff",garageName:"Garage Starter Auto",subscriptionTier:"starter"},{email:null,username:"starter_staff2",password:"staff123",name:"Youssef Trabelsi",role:"staff",garageName:"Garage Starter Auto",subscriptionTier:"starter"},{email:"pro@opauto.tn",username:null,password:"pro123",name:"Karim Gharbi",role:"owner",garageName:"Garage Professional Motors",subscriptionTier:"professional"},{email:null,username:"pro_mechanic1",password:"staff123",name:"Fatma Slimani",role:"staff",garageName:"Garage Professional Motors",subscriptionTier:"professional"},{email:null,username:"pro_mechanic2",password:"staff123",name:"Ali Bouzid",role:"staff",garageName:"Garage Professional Motors",subscriptionTier:"professional"},{email:null,username:"pro_mechanic3",password:"staff123",name:"Leila Mabrouk",role:"staff",garageName:"Garage Professional Motors",subscriptionTier:"professional"},{email:null,username:"pro_receptionist",password:"staff123",name:"Nadia Hamdi",role:"staff",garageName:"Garage Professional Motors",subscriptionTier:"professional"},{email:null,username:"pro_inventory",password:"staff123",name:"Hichem Louati",role:"staff",garageName:"Garage Professional Motors",subscriptionTier:"professional"}],a=e.emailOrUsername.includes("@"),t=r.find(l=>a?l.email===e.emailOrUsername&&l.password===e.password:l.username===e.emailOrUsername&&l.password===e.password);if(!t)return s(()=>({code:"INVALID_CREDENTIALS",message:u.INVALID_CREDENTIALS}));let h={user:{id:`user_${Date.now()}`,email:t.email||void 0,username:t.username||void 0,name:t.name,role:t.role,garageName:t.garageName,isActive:!0,createdAt:new Date("2024-01-01"),updatedAt:new Date,lastLogin:new Date,subscriptionTier:t.subscriptionTier,preferences:{theme:"system",language:"en",notifications:{email:!!t.email,sms:!1,browser:!0},dashboardLayout:"standard"}},token:`mock_token_${Date.now()}`,refreshToken:`mock_refresh_${Date.now()}`,expiresIn:3600};return o(h)}validateRegistrationData(e){if(e.password!==e.confirmPassword)return s(()=>({code:"PASSWORDS_DONT_MATCH",message:"Passwords do not match"}));if(!e.acceptTerms)return s(()=>({code:"TERMS_NOT_ACCEPTED",message:"You must accept the terms and conditions"}));let t={user:{id:`user_${Date.now()}`,email:e.email,name:e.name,role:"owner",garageName:e.garageName,phoneNumber:e.phoneNumber,isActive:!0,createdAt:new Date,updatedAt:new Date,preferences:{theme:"system",language:"en",notifications:{email:!0,sms:!1,browser:!0},dashboardLayout:"standard"}},token:`mock_token_${Date.now()}`,refreshToken:`mock_refresh_${Date.now()}`,expiresIn:3600};return o(t)}storeAuthData(e,r){let a=r?localStorage:sessionStorage;a.setItem(this.STORAGE_KEYS.TOKEN,e.token),a.setItem(this.STORAGE_KEYS.REFRESH_TOKEN,e.refreshToken),a.setItem(this.STORAGE_KEYS.USER,JSON.stringify(e.user)),r&&localStorage.setItem(this.STORAGE_KEYS.REMEMBER_ME,"true")}clearAuthData(){[localStorage,sessionStorage].forEach(e=>{Object.values(this.STORAGE_KEYS).forEach(r=>{e.removeItem(r)})})}getUserFromStorage(){try{let e=localStorage.getItem(this.STORAGE_KEYS.USER);return e||(e=sessionStorage.getItem(this.STORAGE_KEYS.USER)),e?JSON.parse(e):null}catch{return null}}hasValidToken(){return!!(localStorage.getItem(this.STORAGE_KEYS.TOKEN)||sessionStorage.getItem(this.STORAGE_KEYS.TOKEN))}checkTokenExpiration(){(localStorage.getItem(this.STORAGE_KEYS.TOKEN)||sessionStorage.getItem(this.STORAGE_KEYS.TOKEN))&&!this.getUserFromStorage()&&(this.clearAuthData(),this.isAuthenticatedSubject.next(!1))}static \u0275fac=function(r){return new(r||c)};static \u0275prov=g({token:c,factory:c.\u0275fac,providedIn:"root"})};export{f as a,d as b};
